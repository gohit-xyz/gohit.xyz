---
import Layout from '@/layouts/Layout.astro'
import { getCollection } from 'astro:content'
import { TimeIcon, ShareIcon } from '@/components/icons/icons'
import BackButtonTwo from '@/components/ui/buttons/BackButtonTwo.astro'
import Decorative from '@/components/ui/effects/Decorative.astro'
import ArrowUpBtn from '@/components/ui/buttons/ArrowUpBtn.astro'
import CircleBtn from '@/components/ui/buttons/CircleBtn.astro'

// Static Paths
export async function getStaticPaths() {
  const articles = await getCollection('articles')
  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article },
  }))
}

// Props & Computed Values
const { article } = Astro.props
const { Content } = await article.render()

const readingTime = Math.ceil(article.body.split(/\s+/).length / 200)
const formattedDate = new Date(article.data.publishDate).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'short',
  day: 'numeric',
})
---

<Layout>
  <article class="relative mx-auto max-w-5xl px-6 py-16 lg:px-8">
    <!-- Decorative Elements -->
    <Decorative variant="blog-post" />

    <!-- Main Content -->
    <div class="relative z-10">
      <!-- Breadcrumb -->
      <nav
        class="mb-12 flex items-center justify-center text-sm text-gray-400"
        aria-label="Breadcrumb"
      >
        <BackButtonTwo href="/blog" text="Blog â—‰" />
      </nav>

      <!-- Header -->
      <header class="mb-16 text-center">
        <h1 class="mb-12 text-5xl leading-tight font-bold tracking-tight lg:text-6xl">
          {article.data.title}
        </h1>

        <!-- Author Avatar -->
        <a href="/" class="mb-12 inline-flex">
          <img
            src={article.data.profile || '/src/assets/images/test/user.png'}
            alt={`${article.data.author || 'Author'}'s avatar`}
            class="h-12 w-12 rounded-full border-4 border-black object-cover shadow-xl ring-2 ring-gray-800 transition-all hover:grayscale"
            width="48"
            height="48"
            loading="lazy"
          />
        </a>

        <!-- Divider -->
        <hr
          class="mx-auto mb-8 h-px w-full max-w-4xl border-0 bg-linear-to-r from-transparent via-gray-800 to-transparent"
        />

        <!-- Meta Info -->
        <div class="flex flex-wrap items-center justify-center gap-6 text-sm text-gray-400">
          <div class="flex items-center gap-2">
            <TimeIcon className="h-4 w-4" />
            <span>{readingTime} min read</span>
          </div>

          {
            article.data.url && (
              <a
                href={article.data.url}
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-2 text-blue-400 transition-colors hover:text-blue-300"
                aria-label="Open external article URL"
              >
                <ShareIcon className="h-4 w-4" />
                <span>Open URL</span>
              </a>
            )
          }

          <time datetime={article.data.publishDate.toString()} class="text-gray-500">
            {formattedDate}
          </time>
        </div>
      </header>

      <!-- Diamond Divider -->
      <div class="relative mx-auto mb-12 max-w-4xl">
        <hr
          class="h-px w-full border-0 bg-linear-to-r from-transparent via-gray-800 to-transparent"
        />
        <div
          class="absolute top-1/2 left-1/2 h-2 w-2 -translate-x-1/2 -translate-y-1/2 rotate-45 border border-gray-700 bg-black"
        >
        </div>
      </div>

      <!-- Content -->
      <div
        class="prose prose-invert prose-lg prose-headings:font-bold prose-headings:tracking-tight prose-h2:mb-6 prose-h2:mt-12 prose-h2:text-3xl prose-h3:mb-4 prose-h3:mt-8 prose-p:leading-normal prose-p:text-gray-300 prose-a:text-blue-400 prose-a:no-underline hover:prose-a:text-blue-300 prose-strong:text-white prose-code:rounded prose-code:bg-transparent prose-code:px-1 prose-code:text-blue-300 prose-code:font-mono prose-pre:rounded-lg prose-pre:border prose-pre:border-gray-700 prose-pre:bg-gray-800 prose-pre:p-4 prose-pre:shadow-lg prose-table:w-full prose-table:border-collapse prose-thead:border-b prose-thead:border-gray-700 prose-th:px-4 prose-th:py-3 prose-th:text-left prose-th:font-semibold prose-th:text-gray-200 prose-th:align-top prose-td:px-4 prose-td:py-3 prose-td:text-gray-300 prose-td:border-t prose-td:border-gray-800 prose-td:align-top prose-tr:border-b prose-tr:border-gray-800 mx-auto max-w-3xl"
      >
        <!-- {article.data.description && (
          <p class="text-xl lead mb-10 leading-relaxed text-gray-400">
            {article.data.description}
          </p>
        )} -->
        <Content />
      </div>

      <!-- Tags -->
      {
        (article.data.tags ?? []).length > 0 && (
          <footer class="mx-auto mt-16 max-w-3xl border-t border-gray-800 pt-8">
            <div class="flex flex-wrap gap-2" role="list">
              {(article.data.tags ?? []).map((tag: string) => (
                <a
                  href={`/tags/${tag.toLowerCase()}`}
                  class="rounded-full bg-gray-900 px-4 py-2 text-sm text-gray-300 ring-1 ring-gray-800 transition-all hover:bg-gray-800 hover:ring-gray-700"
                  role="listitem"
                >
                  {tag}
                </a>
              ))}
            </div>
          </footer>
        )
      }
    </div>
  </article>

  <!-- Floating Scroll to Top Button -->
  <div class="scroll-to-top-wrapper">
    <CircleBtn />
  </div>

</Layout>

<style>
  /* Scroll to Top Button Positioning */
  .scroll-to-top-wrapper {
    position: fixed;
    bottom: 2rem;
    right: 1.5rem;
    z-index: 50;
  }

  /* Desktop: Align with article container */
  @media (min-width: 1024px) {
    .scroll-to-top-wrapper {
      left: 50%;
      right: auto;
      transform: translateX(calc(512px - 4rem));
    }
  }

  article::before {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 1200px;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(156, 163, 175, 0.3), transparent);
    animation: fadeIn 1s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  /* Copy Button*/
  :global(.code-wrapper) {
    position: relative;
  }

  :global(.copy-btn) {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    padding: 0.5rem;
    background: rgba(31, 41, 55, 0.9);
    border: 1px solid rgba(75, 85, 99, 0.6);
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s;
    backdrop-filter: blur(8px);
    z-index: 10;
  }

  :global(.copy-btn:hover) {
    background: rgba(55, 65, 81, 0.95);
    border-color: rgba(107, 114, 128, 0.8);
    transform: scale(1.05);
  }

  :global(.copy-btn:active) {
    transform: scale(0.95);
  }

  :global(.copy-btn svg) {
    width: 1.25rem;
    height: 1.25rem;
    stroke: #9ca3af;
    transition: stroke 0.2s;
  }

  :global(.copy-btn:hover svg) {
    stroke: #d1d5db;
  }

  :global(.copy-btn.copied svg) {
    stroke: #10b981;
  }
</style>

<script>
  const ICONS = {
    copy: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>',
    check:
      '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',
  } as const

  const copyToClipboard = async (btn: HTMLButtonElement, text: string) => {
    try {
      await navigator.clipboard.writeText(text)
      btn.classList.add('copied')
      btn.innerHTML = ICONS.check
      setTimeout(() => {
        btn.classList.remove('copied')
        btn.innerHTML = ICONS.copy
      }, 1500)
    } catch (err) {
      console.error('Copy failed:', err)
    }
  }

  const createCopyButton = (code: string) => {
    const btn = document.createElement('button')
    btn.className = 'copy-btn'
    btn.setAttribute('aria-label', 'Copy code to clipboard')
    btn.innerHTML = ICONS.copy
    btn.onclick = () => copyToClipboard(btn, code)
    return btn
  }

  const initCopyButtons = () => {
    document
      .querySelectorAll<HTMLPreElement>('pre:has(code):not(.code-wrapper pre)')
      .forEach((pre) => {
        const code = pre.querySelector('code')?.textContent?.trim()
        if (!code) return

        const wrapper = document.createElement('div')
        wrapper.className = 'code-wrapper'
        pre.replaceWith(wrapper)
        wrapper.append(pre, createCopyButton(code))
      })
  }

  // Initialize on load and SPA navigation
  document.addEventListener('DOMContentLoaded', initCopyButtons)
  document.addEventListener('astro:page-load', initCopyButtons)
</script>
